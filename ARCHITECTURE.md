# Circle 链上行为追踪器 - 架构设计方案

## 1. 系统概述

该应用是一个**多链 USDC 监控与分析平台**，专注于追踪 Circle 的两大核心业务场景：**Circle Mint（法币兑换）**和 **CCTP（跨链结算）**。系统通过实时事件监听、智能分类和数据持久化，为用户提供完整的链上资金流动追踪和分析能力。

## 2. 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      前端应用 (React + Tailwind)              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  仪表板 | 实时交易列表 | 过滤器 | 可视化分析 | 导出   │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                   tRPC 后端接口层 (Express)                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 交易查询 | 历史追溯 | 批量分析 | 导出 | 统计聚合      │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  业务逻辑层 (Node.js)                        │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 事件分类引擎 | 数据转换 | 通知逻辑 | 数据聚合         │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                  数据访问层 (Drizzle ORM)                    │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ 交易表 | 事件表 | 统计表 | 用户配置表                │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    数据库 (MySQL/TiDB)                       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│              外部数据源 (Web3 RPC 和事件监听)                │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ Ethereum | Base | Arbitrum | Polygon | 其他 EVM 链   │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 3. 数据模型

### 3.1 核心表结构

#### `transactions` 表
存储所有捕获的 USDC 相关交易。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | INT | 主键，自增 |
| `txHash` | VARCHAR(66) | 交易哈希，唯一索引 |
| `chainId` | INT | 链 ID（1=以太坊, 8453=Base, 42161=Arbitrum 等） |
| `chainName` | VARCHAR(50) | 链名称 |
| `blockNumber` | BIGINT | 区块号 |
| `timestamp` | TIMESTAMP | 交易时间戳 |
| `fromAddress` | VARCHAR(42) | 发送方地址 |
| `toAddress` | VARCHAR(42) | 接收方地址 |
| `amount` | DECIMAL(38,6) | USDC 金额 |
| `type` | ENUM('CIRCLE_MINT', 'CIRCLE_BURN', 'CCTP_BURN', 'CCTP_MINT', 'OTHER') | 交易类型 |
| `sourceChain` | VARCHAR(50) | 源链（用于 CCTP） |
| `targetChain` | VARCHAR(50) | 目标链（用于 CCTP） |
| `messageHash` | VARCHAR(66) | CCTP 消息哈希（如适用） |
| `status` | ENUM('PENDING', 'CONFIRMED', 'FAILED') | 交易状态 |
| `rawData` | JSON | 原始事件数据 |
| `createdAt` | TIMESTAMP | 记录创建时间 |
| `updatedAt` | TIMESTAMP | 记录更新时间 |

#### `events` 表
存储所有捕获的智能合约事件日志。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | INT | 主键，自增 |
| `txHash` | VARCHAR(66) | 交易哈希 |
| `logIndex` | INT | 事件日志索引 |
| `chainId` | INT | 链 ID |
| `contractAddress` | VARCHAR(42) | 合约地址 |
| `eventName` | VARCHAR(100) | 事件名称（如 Transfer, MessageSent） |
| `topics` | JSON | 事件主题 |
| `data` | JSON | 事件数据 |
| `blockNumber` | BIGINT | 区块号 |
| `timestamp` | TIMESTAMP | 事件时间戳 |
| `createdAt` | TIMESTAMP | 记录创建时间 |

#### `statistics` 表
存储聚合的统计数据，用于仪表板展示。

| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | INT | 主键，自增 |
| `date` | DATE | 统计日期 |
| `chainId` | INT | 链 ID |
| `type` | VARCHAR(50) | 统计类型（如 MINT_TOTAL, BURN_TOTAL） |
| `count` | INT | 交易数量 |
| `totalAmount` | DECIMAL(38,6) | 总金额 |
| `avgAmount` | DECIMAL(38,6) | 平均金额 |
| `createdAt` | TIMESTAMP | 记录创建时间 |

### 3.2 关键识别逻辑

#### Circle Mint（法币兑换）
识别条件：
- 事件来源：USDC 合约的 `Transfer` 事件
- 发送方：`0x0`（零地址）
- 接收方：机构地址（Circle 官方 Minter）
- 无 CCTP 相关事件（`MessageSent` 或 `MessageReceived`）

#### Circle Burn（法币赎回）
识别条件：
- 事件来源：USDC 合约的 `Transfer` 事件
- 发送方：机构地址
- 接收方：`0x0`（零地址）
- 无 CCTP 相关事件

#### CCTP Burn（跨链销毁）
识别条件：
- 事件来源：USDC 合约的 `Transfer` 事件 + `TokenMessenger` 合约的 `MessageSent` 事件
- 发送方：非零地址
- 接收方：`0x0`（零地址）
- 同一笔交易中存在 `MessageSent` 事件

#### CCTP Mint（跨链铸造）
识别条件：
- 事件来源：USDC 合约的 `Transfer` 事件 + `MessageTransmitter` 合约的 `MessageReceived` 事件
- 发送方：`0x0`（零地址）
- 接收方：非零地址
- 同一笔交易中存在 `MessageReceived` 事件

## 4. 功能模块

### 4.1 后端模块

#### 事件监听器（Event Listener）
- 连接到多条链的 RPC 节点
- 监听 USDC 合约和 CCTP 合约的事件
- 实时捕获新交易并分类
- 存储到数据库

#### 事件分类引擎（Classification Engine）
- 根据事件特征和交易上下文自动分类
- 识别 Circle Mint、CCTP 等业务行为
- 过滤无关的 DeFi/NFT 交互

#### 历史追溯模块（Historical Tracker）
- 支持通过交易哈希查询历史交易
- 支持通过地址查询关联交易
- 支持时间范围查询

#### 批量分析模块（Batch Analyzer）
- 支持批量导入交易哈希或地址
- 执行批量分类和分析
- 生成分析报告

### 4.2 前端模块

#### 仪表板（Dashboard）
- 展示实时统计数据（总 Mint 数量、总 Burn 数量等）
- 展示 Mint/Burn 趋势图表
- 展示链间流量分布

#### 交易列表（Transaction List）
- 展示所有捕获的交易
- 支持分页和排序
- 支持点击查看交易详情

#### 过滤器（Filters）
- 时间范围过滤
- 金额范围过滤
- 链类型过滤
- 交易类型过滤

#### 导出功能（Export）
- 导出为 CSV 格式
- 导出为 Excel 格式
- 支持自定义导出字段

## 5. 关键技术选型

| 组件 | 技术 | 说明 |
| :--- | :--- | :--- |
| 前端框架 | React 19 + Tailwind 4 | 现代 UI 框架 |
| 后端框架 | Express 4 + tRPC 11 | 类型安全的 API |
| 数据库 | MySQL/TiDB + Drizzle ORM | 关系型数据库 |
| Web3 库 | ethers.js 或 viem | 与区块链交互 |
| 图表库 | Recharts | 数据可视化 |
| 导出库 | xlsx, papaparse | 数据导出 |

## 6. 开发优先级

### 第一阶段（MVP）
1. 数据库设计和迁移
2. 基础的事件分类逻辑
3. 交易查询接口
4. 前端交易列表展示
5. 基础过滤功能

### 第二阶段
1. 实时事件监听器
2. 历史追溯功能
3. 导出功能
4. 可视化图表

### 第三阶段
1. 批量分析功能
2. 通知系统
3. 性能优化
4. 文档和测试

## 7. 部署与运维

- **前端**：部署到 Manus 平台
- **后端**：Express 服务器在 Manus 平台上运行
- **数据库**：MySQL/TiDB 托管服务
- **事件监听**：后台 Node.js 进程或定时任务

## 8. 安全与合规

- 所有 API 调用需要身份验证
- 敏感数据（如私钥）不存储在数据库中
- 实现速率限制防止滥用
- 记录所有数据访问日志
